{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Energy" %}{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold mb-6">{% trans "Renewable Energy Tracker" %}</h1>

<p class="text-gray-600 mb-6">
  Monitor your farm’s renewable energy usage and costs. 
  This dashboard helps you track daily energy consumption, understand cost savings compared to diesel, 
  and identify which equipment uses the most power.
</p>

<!-- KPI CARDS -->
<div class="grid md:grid-cols-4 gap-4 mb-8">
  <div class="bg-white p-4 rounded-2xl shadow">
    <div class="text-xs text-gray-500">{% trans "Total kWh (30d)" %}</div>
    <div class="text-2xl font-bold">{{ totals.kwh }}</div>
  </div>
  <div class="bg-white p-4 rounded-2xl shadow">
    <div class="text-xs text-gray-500">{% trans "Total Cost (30d)" %}</div>
    <div class="text-2xl font-bold">₦{{ totals.cost_ngn }}</div>
  </div>
  <div class="bg-white p-4 rounded-2xl shadow">
    <div class="text-xs text-gray-500">{% trans "Avg ₦/kWh" %}</div>
    <div class="text-2xl font-bold">₦{{ totals.avg_cost_per_kwh }}</div>
    <div class="text-[11px] text-gray-500 mt-1">{% trans "Diesel ref" %}: ₦{{ diesel_ref }}/kWh</div>
  </div>
  <div class="bg-white p-4 rounded-2xl shadow">
    <div class="text-xs text-gray-500">{% trans "Est. Savings vs Diesel (30d)" %}</div>
    <div class="text-2xl font-bold">₦{{ totals.est_savings }}</div>
  </div>
</div>

{% comment %} <!-- PRODUCTS -->
<h2 class="font-semibold mt-2 mb-3">{% trans "Products" %}</h2>
<div class="grid md:grid-cols-3 gap-6 mb-10">
  {% for p in products %}
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="font-semibold">{{ p.title }}</div>
    <div class="text-xs text-gray-600">{{ p.vendor }} • {{ p.product_type }}</div>
    <div class="text-sm">{{ p.capacity }}</div>
    <div class="text-sm font-medium">₦{{ p.price_text }}</div>
    <p class="text-sm text-gray-700 mt-2">{{ p.description|default:"" }}</p>
  </div>
  {% empty %}
  <p class="text-gray-600">{% trans "No products yet." %}</p>
  {% endfor %}
</div> {% endcomment %}

<!-- CHARTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ chart_data|json_script:"energy-data" }}  <!-- <-- was chart_json -->


<div class="grid lg:grid-cols-2 gap-6">
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="font-semibold mb-2">{% trans "Daily kWh (last 30 days)" %}</div>
    <canvas id="kwhChart" height="140"></canvas>
  </div>
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="font-semibold mb-2">{% trans "kWh by Equipment (30d)" %}</div>
    <canvas id="equipChart" height="140"></canvas>
  </div>
</div>

{% if role == 'farmer' %}
  <!-- TABLE + LOG LINK for farmers only -->
  <h2 class="font-semibold mt-10 mb-2">{% trans "Energy Usage (last 10)" %}</h2>
  <div class="bg-white p-4 rounded-2xl shadow overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead><tr class="text-left">
        <th class="py-2 pr-4">{% trans "Date" %}</th>
        <th class="py-2 pr-4">{% trans "Equipment" %}</th>
        <th class="py-2 pr-4">kWh</th>
        <th class="py-2 pr-4">₦</th>
      </tr></thead>
      <tbody>
        {% for u in usage %}
        <tr class="border-t">
          <td class="py-2 pr-4">{{ u.date }}</td>
          <td class="py-2 pr-4">{{ u.equipment }}</td>
          <td class="py-2 pr-4">{{ u.kwh }}</td>
          <td class="py-2 pr-4">{{ u.cost_ngn }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="mt-3">
      <a class="px-4 py-2 bg-black text-white rounded-xl" href="/energy/usage/">{% trans "Log Usage" %}</a>
    </div>
  </div>
{% endif %}

<script>
  const data = JSON.parse(document.getElementById('energy-data').textContent);

  // Line chart: daily kWh
  new Chart(document.getElementById('kwhChart'), {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{ label: 'kWh', data: data.kwhSeries, tension: 0.3 }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });

  // Bar chart: equipment share
  new Chart(document.getElementById('equipChart'), {
    type: 'bar',
    data: {
      labels: data.equipLabels,
      datasets: [{ label: 'kWh', data: data.equipSeries }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });
</script>
{% endblock %}
