{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Energy" %}{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold mb-2">{% trans "Renewable Energy Tracker" %}</h1>
<p class="text-gray-600 mb-6">
  {% trans "Monitor your farmâ€™s renewable energy usage and costs. ..." %}
</p>
<!-- Promo: connect with renewable energy sellers -->
<div class="mt-8 mb-6 rounded-2xl p-6 md:p-7 text-white shadow
            bg-gradient-to-r from-blue-600 to-blue-500">
  <div class="flex items-start gap-4">
    <div class="text-2xl md:text-3xl leading-none">ðŸ‘¥</div>
    <div class="flex-1">
      <h3 class="text-lg md:text-xl font-semibold">Need New Equipment?</h3>
      <p class="mt-1 text-blue-100">
        Connect with verified renewable energy sellers for the best deals on solar equipment and cold storage solutions.
      </p>
      <a href="https://harvestpadi.vercel.app/farmer"
         target="_blank" rel="noopener"
         class="inline-block mt-4 px-5 py-2 rounded-xl bg-white text-blue-600 font-medium hover:bg-blue-50">
        Connect with renewable energy sellers
      </a>
    </div>
  </div>
</div>

<!-- Add Unit button -->
<div class="mb-4">
  <a href="{% url 'energy_unit_new' %}"
     class="inline-flex items-center px-4 py-2 rounded-xl text-white"
     style="background:#F97316;">
    + Add Unit
  </a>
</div>

<h1 class="text-3xl font-bold mb-6">{% trans "Renewable Energy Tracker" %}</h1>

<p class="text-gray-600 mb-6">
  Monitor your farmâ€™s renewable energy usage and costs. 
  This dashboard helps you track daily energy consumption, understand cost savings compared to diesel, 
  and identify which equipment uses the most power.
</p>

<!-- KPI CARDS -->
<div class="grid md:grid-cols-4 gap-4 mb-8">
  <div class="bg-white p-4 rounded-2xl shadow">
    <div class="text-xs text-gray-500">{% trans "Total kWh (30d)" %}</div>
    <div class="text-2xl font-bold">{{ totals.kwh }}</div>
  </div>
  <div class="bg-white p-4 rounded-2xl shadow">
    <div class="text-xs text-gray-500">{% trans "Total Cost (30d)" %}</div>
    <div class="text-2xl font-bold">â‚¦{{ totals.cost_ngn }}</div>
  </div>
  <div class="bg-white p-4 rounded-2xl shadow">
    <div class="text-xs text-gray-500">{% trans "Avg â‚¦/kWh" %}</div>
    <div class="text-2xl font-bold">â‚¦{{ totals.avg_cost_per_kwh }}</div>
    <div class="text-[11px] text-gray-500 mt-1">{% trans "Diesel ref" %}: â‚¦{{ diesel_ref }}/kWh</div>
  </div>
  <div class="bg-white p-4 rounded-2xl shadow">
    <div class="text-xs text-gray-500">{% trans "Est. Savings vs Diesel (30d)" %}</div>
    <div class="text-2xl font-bold">â‚¦{{ totals.est_savings }}</div>
  </div>
</div>

{% comment %} <!-- PRODUCTS -->
<h2 class="font-semibold mt-2 mb-3">{% trans "Products" %}</h2>
<div class="grid md:grid-cols-3 gap-6 mb-10">
  {% for p in products %}
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="font-semibold">{{ p.title }}</div>
    <div class="text-xs text-gray-600">{{ p.vendor }} â€¢ {{ p.product_type }}</div>
    <div class="text-sm">{{ p.capacity }}</div>
    <div class="text-sm font-medium">â‚¦{{ p.price_text }}</div>
    <p class="text-sm text-gray-700 mt-2">{{ p.description|default:"" }}</p>
  </div>
  {% empty %}
  <p class="text-gray-600">{% trans "No products yet." %}</p>
  {% endfor %}
</div> {% endcomment %}

{% if units %}
  <h2 class="font-semibold mt-8 mb-2">{% trans "Your Energy Units" %}</h2>
  <div class="grid md:grid-cols-3 gap-4">
    {% for u in units %}
    <div class="bg-white p-4 rounded-2xl shadow">
      <div class="text-sm text-gray-500">{{ u.get_unit_type_display }}</div>
      <div class="font-semibold">{{ u.name }}</div>
      <div class="text-sm text-gray-600">{{ u.capacity }}</div>
      {% if u.efficiency_pct %}<div class="text-sm">Eff.: {{ u.efficiency_pct }}%</div>{% endif %}
    </div>
    {% endfor %}
  </div>
{% endif %}

<!-- CHARTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ chart_data|json_script:"energy-data" }}  <!-- <-- was chart_json -->


<div class="grid lg:grid-cols-2 gap-6">
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="font-semibold mb-2">{% trans "Daily kWh (last 30 days)" %}</div>
    <canvas id="kwhChart" height="140"></canvas>
  </div>
  <div class="bg-white p-5 rounded-2xl shadow">
    <div class="font-semibold mb-2">{% trans "kWh by Equipment (30d)" %}</div>
    <canvas id="equipChart" height="140"></canvas>
  </div>
</div>

{% if role == 'farmer' %}
  <!-- TABLE + LOG LINK for farmers only -->
  <h2 class="font-semibold mt-10 mb-2">{% trans "Energy Usage (last 10)" %}</h2>
  <div class="bg-white p-4 rounded-2xl shadow overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead><tr class="text-left">
        <th class="py-2 pr-4">{% trans "Date" %}</th>
        <th class="py-2 pr-4">{% trans "Equipment" %}</th>
        <th class="py-2 pr-4">kWh</th>
        <th class="py-2 pr-4">â‚¦</th>
      </tr></thead>
      <tbody>
        {% for u in usage %}
        <tr class="border-t">
          <td class="py-2 pr-4">{{ u.date }}</td>
          <td class="py-2 pr-4">{{ u.equipment }}</td>
          <td class="py-2 pr-4">{{ u.kwh }}</td>
          <td class="py-2 pr-4">{{ u.cost_ngn }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="mt-3">
      <a class="px-4 py-2 bg-black text-white rounded-xl" href="/energy/usage/">{% trans "Log Usage" %}</a>
    </div>
  </div>
{% endif %}

<script>
  const data = JSON.parse(document.getElementById('energy-data').textContent);

  // Line chart: daily kWh
  new Chart(document.getElementById('kwhChart'), {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{ label: 'kWh', data: data.kwhSeries, tension: 0.3 }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });

  // Bar chart: equipment share
  new Chart(document.getElementById('equipChart'), {
    type: 'bar',
    data: {
      labels: data.equipLabels,
      datasets: [{ label: 'kWh', data: data.equipSeries }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });
</script>
{% endblock %}
